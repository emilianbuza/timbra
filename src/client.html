<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timbra AI – Browser Call</title>

    <!-- ⚡ Neue Twilio Voice SDK (v2.9.1) -->
    <script src="https://sdk.twilio.com/js/voice/releases/2.9.1/twilio-voice.min.js"></script>
    <script>
      // Sicherstellen, dass globaler Alias existiert
      window.Twilio = window.TwilioVoice;
    </script>

    <style>
      body {
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: #f5f5f5;
      }
      button {
        background: #007aff;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 10px;
        cursor: pointer;
      }
      button:disabled {
        background: gray;
      }
    </style>
  </head>
  <body>
    <h1>Timbra AI Telefon</h1>
    <button id="callButton" disabled>Verbinden...</button>

    <script>
      async function init() {
        try {
          const res = await fetch("/token");
          const data = await res.json();
          const token = data.token;

          // Twilio.Device aus globalem Namespace (nach Alias)
          const device = new Twilio.Device(token, {
            codecPreferences: ["opus", "pcmu"],
            debug: true,
          });

          const callButton = document.getElementById("callButton");
          callButton.textContent = "Verbinden...";
          callButton.disabled = true;

          device.on("ready", () => {
            callButton.textContent = "Anrufen";
            callButton.disabled = false;
          });

          device.on("error", (err) => {
            alert("Fehler: " + err.message);
            console.error(err);
          });

          callButton.addEventListener("click", () => {
            const params = { To: "+17242133382" }; // deine Twilio-Nummer
            device.connect(params);
            callButton.textContent = "Ruf läuft...";
            callButton.disabled = true;
          });
        } catch (err) {
          alert("Fehler beim Initialisieren: " + err.message);
          console.error(err);
        }
      }

      // Warten bis SDK wirklich geladen ist
      window.addEventListener("load", init);
    </script>
  </body>
</html>
